<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IV Breakout Scanner v6 - Professional Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #1e293b;
      --bg-card-hover: #2d3748;
      --bg-glass: rgba(255, 255, 255, 0.05);
      --bg-sidebar: #0f172a;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --accent-primary: #3b82f6;
      --accent-primary-light: #60a5fa;
      --accent-success: #10b981;
      --accent-warning: #f59e0b;
      --accent-danger: #ef4444;
      --border-color: rgba(255, 255, 255, 0.08);
      --border-light: rgba(255, 255, 255, 0.05);
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --transition: all 0.2s ease;
    }
    
    body.light {
      --bg-primary: #f8fafc;
      --bg-secondary: #f1f5f9;
      --bg-card: #ffffff;
      --bg-card-hover: #f8fafc;
      --bg-glass: rgba(0, 0, 0, 0.05);
      --bg-sidebar: #ffffff;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      --border-color: rgba(0, 0, 0, 0.08);
      --border-light: rgba(0, 0, 0, 0.05);
    }
    
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      overflow: hidden;
      font-weight: 400;
      line-height: 1.5;
    }
    
    /* Sidebar */
    .sidebar {
      width: 320px;
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-md);
      z-index: 10;
    }
    
    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .sidebar-header i {
      color: var(--accent-primary);
    }
    
    .controls {
      padding: 1.25rem;
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    .controls input, .controls select {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 0.75rem;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      transition: var(--transition);
      flex: 1;
      min-width: 120px;
    }
    
    .controls input:focus, .controls select:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .controls button {
      background: var(--accent-primary);
      color: white;
      border: none;
      padding: 0.75rem 1rem;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      transition: var(--transition);
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
      justify-content: center;
    }
    
    .controls button:hover {
      background: var(--accent-primary-light);
      transform: translateY(-1px);
    }
    
    .watchlist {
      flex: 1;
      overflow-y: auto;
      padding: 0 1.25rem 1.25rem;
    }
    
    .watchlist-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .watchlist-header h3 {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .watch-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 0.875rem;
      margin-bottom: 0.75rem;
      transition: var(--transition);
    }
    
    .watch-item:hover {
      background: var(--bg-card-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    .watch-item .symbol {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .watch-item select {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      min-width: 120px;
      padding: 0.5rem;
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
    }
    
    .watch-item button {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.25rem;
      border-radius: var(--radius-sm);
      transition: var(--transition);
    }
    
    .watch-item button:hover {
      color: var(--accent-danger);
      background: rgba(239, 68, 68, 0.1);
    }
    
    .settings {
      padding: 1.25rem;
      border-top: 1px solid var(--border-color);
    }
    
    .settings h4 {
      margin-bottom: 1rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    
    .settings label {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      font-size: 0.8rem;
      cursor: pointer;
      color: var(--text-secondary);
      transition: var(--transition);
    }
    
    .settings label:hover {
      color: var(--text-primary);
    }
    
    .settings input[type="checkbox"] {
      accent-color: var(--accent-primary);
    }
    
    /* Main Content */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      overflow: hidden;
    }
    
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
    }
    
    .topbar-group {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    
    .pills {
      display: flex;
      gap: 0.5rem;
      background: var(--bg-secondary);
      padding: 0.25rem;
      border-radius: var(--radius-md);
    }
    
    .pill {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      padding: 0.5rem 1rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: var(--transition);
    }
    
    .pill.active {
      background: var(--accent-primary);
      color: white;
    }
    
    .pill:hover:not(.active) {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }
    
    .topbar input, .topbar select {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 0.5rem 0.75rem;
      border-radius: var(--radius-sm);
      width: 80px;
      font-size: 0.8rem;
    }
    
    .topbar input:focus {
      border-color: var(--accent-primary);
    }
    
    .scan-button {
      background: var(--accent-success);
      color: white;
      padding: 0.5rem 1.25rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      border: none;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: var(--transition);
    }
    
    .scan-button:hover {
      background: #059669;
      transform: translateY(-1px);
    }
    
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }
    
    .presets {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }
    
    .preset {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .preset:hover {
      background: var(--accent-primary);
      color: white;
      transform: translateY(-1px);
    }
    
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      box-shadow: var(--shadow-md);
      margin-bottom: 1.5rem;
      backdrop-filter: blur(10px);
      transition: var(--transition);
    }
    
    
    .card:hover {
      box-shadow: var(--shadow-lg);
    }
    
    .card-header {
      font-weight: 600;
      padding: 0.75rem 1rem;
      background: var(--bg-glass);
      border-bottom: 1px solid var(--border-color);
      margin: -1.5rem -1.5rem 1.5rem;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    
    .table thead th {
      position: sticky;
      top: 0;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .table tbody td {
      border-bottom: 1px solid var(--border-light);
      padding: 0.75rem;
      vertical-align: middle;
    }
    
    .table tbody tr:hover {
      background: var(--bg-glass);
    }
    
    .badge {
      background: var(--accent-primary);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .hits {
      display: flex;
      gap: 0.25rem;
      flex-wrap: wrap;
    }
    
    .hit {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      border: 1px solid var(--border-color);
      background: var(--bg-glass);
      font-size: 0.75rem;
      color: var(--text-secondary);
      transition: var(--transition);
    }
    
    .hit.best {
      border-color: var(--accent-success);
      background: var(--accent-success);
      color: white;
    }
    
    .hit:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    .faded {
      opacity: 0.6;
      color: var(--text-muted);
    }
    
    .straddle-price {
      font-weight: 500;
      color: var(--accent-success);
    }
    
    @media (max-width: 768px) {
      .sidebar { width: 100%; height: auto; }
      .main { order: -1; }
      .topbar { flex-direction: column; gap: 1rem; }
    }
    
    body.compact .table tbody td { padding: 0.5rem; font-size: 0.75rem; }
    body.compact .hit { padding: 0.125rem 0.375rem; font-size: 0.7rem; }
    body.compact .watch-item { padding: 0.5rem; }
    
    .load-suggested {
      background: var(--accent-success);
      color: white;
      border: none;
      padding: 0.75rem 1rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 0.875rem;
      margin: 0 1.25rem 1rem;
      width: calc(100% - 2.5rem);
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-weight: 500;
    }
    
    .load-suggested:hover {
      background: #059669;
      transform: translateY(-1px);
    }
    
    .row-glow {
      animation: row-glow-anim 1.8s ease;
      box-shadow: 0 6px 18px rgba(255, 196, 77, 0.12);
      border-left: 4px solid rgba(255,196,77,0.9);
    }
    
    @keyframes row-glow-anim {
      0% { background: rgba(255,235,205,0.95); }
      40% { background: rgba(255,248,230,0.6); }
      100% { background: transparent; }
    }
    
    .last-updated {
      position: fixed;
      right: 18px;
      bottom: 12px;
      background: rgba(0,0,0,0.45);
      color: #ffd78c;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      z-index: 9999;
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255, 215, 130, 0.12);
    }
    
    body.light .last-updated { background: rgba(255,255,255,0.9); color: #b45309; border-color: rgba(218,165,32,0.12); }
    
    .row-glow-ce { animation: row-glow-anim-ce 1.8s ease; box-shadow: 0 6px 18px rgba(34,197,94,0.10); border-left: 4px solid rgba(34,197,94,0.9); }
    .row-glow-pe { animation: row-glow-anim-pe 1.8s ease; box-shadow: 0 6px 18px rgba(239,68,68,0.10); border-left: 4px solid rgba(239,68,68,0.9); }
    
    @keyframes row-glow-anim-ce { 0% { background: rgba(220,255,233,0.95); } 40% { background: rgba(230,255,240,0.6); } 100% { background: transparent; } }
    @keyframes row-glow-anim-pe { 0% { background: rgba(255,235,235,0.95); } 40% { background: rgba(255,240,240,0.6); } 100% { background: transparent; } }

    /* Tab Animation */
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Filter Section */
    .filter-section {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 1rem;
      font-size: 0.875rem;
      background: var(--bg-card);
      padding: 1rem;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
    }
    
    .filter-section label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
    }
    
    .filter-section input {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 0.5rem;
      border-radius: var(--radius-sm);
      width: 70px;
    }
    
    .filter-section .divider {
      color: var(--text-muted);
      margin: 0 0.5rem;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <i class="fas fa-chart-line"></i>
      IV Scanner Watchlist
    </div>
    
    <div class="controls">
      <input id="symInput" placeholder="Add symbol (e.g., SBIN)" />
      <button id="addSym">
        <i class="fas fa-plus"></i>
        Add
      </button>
      <select id="viewMode">
        <option value="multi" selected>Multi View</option>
        <option value="single">Single View</option>
      </select>
    </div>
    
    <button id="loadSuggested" class="load-suggested">
      <i class="fas fa-bolt"></i>
      Load Suggested Symbols
    </button>
    
    <div class="watchlist">
      <div class="watchlist-header">
        <h3>Watched Symbols</h3>
        <span class="badge" id="symbolCount">0</span>
      </div>
      <div id="watch"></div>
    </div>
    
    <div class="settings">
      <h4>
        <i class="fas fa-sliders-h"></i>
        Display Options
      </h4>
      <div class="settings-grid">
        <label><input type="checkbox" id="optStrategy" checked> Strategy Cards</label>
        <label><input type="checkbox" id="optHeatmap" checked> IV Heatmap</label>
        <label><input type="checkbox" id="optBest"> Best Hits Only</label>
        <label><input type="checkbox" id="optLTP" checked> Show LTP</label>
        <label><input type="checkbox" id="optCompact"> Compact Mode</label>
        <label><input type="checkbox" id="optLight"> Light Theme</label>
        <label><input type="checkbox" id="optLTPFilter"> LTP Filter</label>
      </div>
    </div>
  </div>
  

  <div class="main">
    <div class="topbar">
      <div class="topbar-group">
        <!-- Main Tabs -->
        <div class="pills" id="mainTabs">
          <button class="pill active" data-tab="breakout">
            <i class="fas fa-chart-bar"></i>
            IV Breakout
          </button>
          <button class="pill" data-tab="strategy">
            <i class="fas fa-chess-board"></i>
            Strategy Finder
          </button>
          <button class="pill" data-tab="surge">
            <i class="fas fa-bomb"></i>
            Premium Surge
          </button>
        </div>
      </div>

      <div class="topbar-group">
        <button id="scanBtn" class="scan-button">
          <i class="fas fa-search"></i>
          Scan Now
        </button>
        <select id="timerSel">
          <option value="0">Manual</option>
          <option value="30">30s Auto</option>
          <option value="60">1m Auto</option>
          <option value="300">5m Auto</option>
        </select>
        <div id="countdown" style="font-weight: 500; color: var(--accent-primary); min-width: 50px; display: flex; align-items: center;">
          <i class="fas fa-clock"></i>
          <span style="margin-left: 5px;">-</span>
        </div>
      </div>
    </div>

    <div class="content">
      <!-- === IV Breakout Tab === -->
      <div id="tab-breakout" class="tab-content active">
        <div id="rangeInfo" style="margin-bottom:12px; color:var(--text-muted); font-size:0.9rem;"></div>
        
        <div class="presets">
          <button class="preset" data-preset="scalp">
            <i class="fas fa-bolt"></i>
            Scalp (3%)
          </button>
          <button class="preset" data-preset="swing">
            <i class="fas fa-wave-square"></i>
            Swing (6%)
          </button>
          <button class="preset" data-preset="highiv">
            <i class="fas fa-arrow-up"></i>
            High IV (10%)
          </button>
          <button class="preset" data-preset="lowiv">
            <i class="fas fa-arrow-down"></i>
            Low IV (2.5%)
          </button>
          <button class="preset" data-preset="reset">
            <i class="fas fa-redo"></i>
            Reset
          </button>
        </div>

        <div class="filter-section">
          <label>Threshold: 
            <input id="thr" type="number" step="0.5" value="5" min="0" />
          </label>
          
          <label>Distance from ATM (%): 
            <input id="distancePct" type="number" step="0.5" value="0" min="0" />
          </label>
          
          <label>LTP Range:
            <input id="ltpMin" type="number" step="0.05" placeholder="Min" />
            <span class="divider">—</span>
            <input id="ltpMax" type="number" step="0.05" placeholder="Max" />
          </label>
          
          <div class="pills" id="sidePills">
            <button class="pill active" data-side="ALL">ALL</button>
            <button class="pill" data-side="CE">CE</button>
            <button class="pill" data-side="PE">PE</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <i class="fas fa-table"></i>
            IV Breakout Results
          </div>
          <table class="table">
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Expiry</th>
                <th>Underlying</th>
                <th>ATM CE IV</th>
                <th>ATM PE IV</th>
                <th>Straddle</th>
                <th>CE Hits</th>
                <th>PE Hits</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
      <!-- === Premium Surge Tab === -->
      <div id="tab-surge" class="tab-content">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-bomb"></i>
            Premium Surge (OTM Premium Bomb Detector)
          </div>

          <div class="filter-section">
            <label>Min % Jump:
              <input id="surgeMinPct" type="number" value="200" step="10" />
            </label>

            <label>Min Lots:
              <input id="surgeMinLots" type="number" value="1" step="0.1" />
            </label>

            <label>Symbol (optional):
              <input id="surgeSymbol" placeholder="e.g. NIFTY" />
            </label>

            <label style="margin-left:auto; display:flex; gap:1rem; align-items:center;">
              <label style="display:flex; align-items:center; gap:0.5rem; margin:0;">
                <input id="surgeSound" type="checkbox" checked> <span>Sound</span>
              </label>
              <label style="display:flex; align-items:center; gap:0.5rem; margin:0;">
                <input id="surgeNotify" type="checkbox" checked> <span>Notify</span>
              </label>
            </label>

            <button id="surgeScanBtn"
              style="background:#ef4444;color:#fff;padding:0.5rem 0.8rem;border-radius:8px;border:none;cursor:pointer;display:flex;align-items:center;gap:0.5rem;">
              <i class="fas fa-bell"></i>
              Scan Surge
            </button>
          </div>

          <!-- Responsive Table Wrapper -->
          <div style="overflow-x:auto; margin-top:1rem;">
            <table class="table" style="min-width:800px;">
              <thead>
  <tr>
    <th>Symbol</th>
    <th>Strike</th>
    <th>Side</th>
    <th>Prev</th>
    <th>Curr</th>
    <th>Pct %</th>
    <th>Strength</th>      <!-- NAYA -->
    <th>Type</th>          <!-- NAYA -->
    <th>Speed %</th>       <!-- NAYA -->
    <th>Time</th>          <!-- NAYA -->
    <th>Vol</th>
    <th>Lots</th>
    <th>Expiry</th>
  </tr>
</thead>
              <tbody id="surgeTbody"></tbody>
            </table>
          </div>
          <div style="padding:0.5rem 0; font-size:0.8rem; color:var(--text-muted); text-align:center;">
            Real-time scanning every 15s when tab is active
          </div>
        </div>
      </div>

      <!-- === Strategy Finder Tab === -->
      <div id="tab-strategy" class="tab-content">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-chess-board"></i>
            Strategy LTP Scanner
          </div>

          <div class="filter-section">
            <label>Buy Lots:
              <input id="buyLots" type="number" value="1" min="1" />
            </label>
            
            <label>Sell Lots:
              <input id="sellLots" type="number" value="3" min="1" />
            </label>
            
            <label>Target From ₹:
              <input id="targetMin" type="number" value="5" step="0.5" />
            </label>
            
            <label>To ₹:
              <input id="targetMax" type="number" value="15" step="0.5" />
            </label>
            
            <label>ATM % From:
              <input id="atmFromPct" type="number" value="0" step="0.5" min="0" />
            </label>
            
            <label>To:
              <input id="atmToPct" type="number" value="5" step="0.5" min="0" />
            </label>
            
            <label>Side:
              <select id="optSide">
                <option value="ALL" selected>ALL</option>
                <option value="CE">CE</option>
                <option value="PE">PE</option>
              </select>
            </label>
            
            <label>Min Strike Diff %:
              <input id="minStrikeDiff" type="number" value="1" step="0.1" />
            </label>
            
            <label>Max Strike Diff %:
              <input id="maxStrikeDiff" type="number" value="10" step="0.1" />
            </label>
            
            <button id="strategyScanBtn" style="background:#f59e0b;color:#fff;padding:0.5rem 0.8rem;border-radius:8px;border:none;cursor:pointer;display:flex;align-items:center;gap:0.5rem;">
              <i class="fas fa-search"></i>
              Find Strategy
            </button>
          </div>

          <table class="table">
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Underlying</th>
                <th>Buy</th>
                <th>Sell</th>
                <th>Buy LTP</th>
                <th>Sell LTP</th>
                <th>Net/Lot</th>
                <th>Total ₹</th>
                <th>Expiry</th>
              </tr>
            </thead>
            <tbody id="strategyTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  


  <div class="last-updated" id="lastUpdated">
    <i class="fas fa-sync-alt"></i>
    Last updated: -
  </div>

  <script>
    // All JavaScript functionality remains exactly the same
    // Only the UI has been updated for a more professional look
    const state = { selected: [], expiries: {}, override: {}, focus: null, left: 0, intervalId: null, countdownId: null };
    const symInput = document.getElementById('symInput');
    const addSym = document.getElementById('addSym');
    const viewMode = document.getElementById('viewMode');
    const watch = document.getElementById('watch');
    const loadSuggested = document.getElementById('loadSuggested');
    const optStrategy = document.getElementById('optStrategy');
    const optHeatmap = document.getElementById('optHeatmap');
    const optBest = document.getElementById('optBest');
    const optLTP = document.getElementById('optLTP');
    const optCompact = document.getElementById('optCompact');
    const optLight = document.getElementById('optLight');
    const optLTPFilter = document.getElementById('optLTPFilter');
    const sidePills = document.getElementById('sidePills');
    const thr = document.getElementById('thr');
    const distInput = document.getElementById('distancePct');
    const ltpMin = document.getElementById('ltpMin');
    const ltpMax = document.getElementById('ltpMax');
    const scanBtn = document.getElementById('scanBtn');
    const timerSel = document.getElementById('timerSel');
    const countEl = document.getElementById('countdown');
    const tbody = document.getElementById('tbody');
    const strategyTbody = document.getElementById('strategyTbody');
    const symbolCount = document.getElementById('symbolCount');

    // Update symbol count
    function updateSymbolCount() {
      symbolCount.textContent = state.selected.length;
    }

    // === Tab Switching ===
    document.getElementById('mainTabs').addEventListener('click', (e) => {
      const tab = e.target.dataset.tab;
      if (!tab) return;
      document.querySelectorAll('#mainTabs .pill').forEach(p => p.classList.toggle('active', p === e.target));
      document.querySelectorAll('.tab-content').forEach(el => {
        el.classList.toggle('active', el.id === `tab-${tab}`);
        el.style.display = el.id === `tab-${tab}` ? 'block' : 'none';
      });
      if (tab === 'breakout') scan();
    });

    // === Preferences ===
    function loadPrefs() {
      const prefs = JSON.parse(localStorage.getItem('ivv6_prefs') || '{}');
      state.selected = prefs.selected || [];
      state.override = prefs.override || {};
      thr.value = prefs.thr || 5;
      optStrategy.checked = prefs.strategy !== false;
      optHeatmap.checked = prefs.heatmap !== false;
      optBest.checked = prefs.best || false;
      optLTP.checked = prefs.ltp !== false;
      optCompact.checked = prefs.compact || false;
      optLight.checked = prefs.light || false;
      optLTPFilter.checked = prefs.ltpfilter || false;
      ltpMin.value = prefs.ltpmin || '';
      ltpMax.value = prefs.ltpmax || '';
      distInput.value = prefs.distance_pct || 0;
      timerSel.value = prefs.timer || 0;
      applyTheme();
      applyCompact();
      updateSymbolCount();
    }

    function savePrefs() {
      localStorage.setItem('ivv6_prefs', JSON.stringify({
        selected: state.selected,
        override: state.override,
        thr: Number(thr.value),
        strategy: optStrategy.checked,
        heatmap: optHeatmap.checked,
        best: optBest.checked,
        ltp: optLTP.checked,
        compact: optCompact.checked,
        light: optLight.checked,
        ltpfilter: optLTPFilter.checked,
        ltpmin: ltpMin.value,
        ltpmax: ltpMax.value,
        distance_pct: Number(distInput.value || 0),
        timer: Number(timerSel.value)
      }));
      updateSymbolCount();
    }

    function applyTheme() {
      document.body.classList.toggle('light', optLight.checked);
    }

    function applyCompact() {
      document.body.classList.toggle('compact', optCompact.checked);
    }

    // === Watchlist & Expiry ===
    async function loadSuggestedSymbols() {
      try {
        const res = await fetch('/api/suggested');
        const data = await res.json();
        state.selected = [...new Set([...state.selected, ...data.symbols.slice(0, 210)])];
        await ensureExpiries();
        renderWatch();
        savePrefs();
        scan();
      } catch (e) {
        state.selected = ['NIFTY', 'BANKNIFTY', 'RELIANCE', 'TCS', 'INFY', 'HDFCBANK', 'ICICIBANK', 'SBIN'];
        await ensureExpiries();
        renderWatch();
        savePrefs();
        scan();
      }
    }

    async function loadOC(sym) {
      try {
        const res = await fetch(`/api/oc?symbol=${sym}`);
        const data = await res.json();
        state.expiries[sym] = data.expiries || [];
      } catch (e) {
        state.expiries[sym] = [];
      }
    }

    async function ensureExpiries() {
      for (let sym of state.selected) {
        if (!state.expiries[sym]) await loadOC(sym);
      }
      renderWatch();
    }

    function renderWatch() {
      watch.innerHTML = '';
      state.selected.forEach(sym => {
        const div = document.createElement('div');
        div.className = 'watch-item';
        div.innerHTML = `
          <span class="symbol">${sym}</span>
          <select onchange="state.override['${sym}']=this.value; savePrefs(); scan();">
            <option value="">Nearest</option>
            ${state.expiries[sym].map(e => `<option value="${e}">${e}</option>`).join('')}
          </select>
          <button onclick="removeSym('${sym}')">
            <i class="fas fa-times"></i>
          </button>
        `;
        watch.appendChild(div);
      });
      updateSymbolCount();
    }

    function removeSym(sym) {
      state.selected = state.selected.filter(s => s !== sym);
      delete state.expiries[sym];
      delete state.override[sym];
      renderWatch();
      savePrefs();
      scan();
    }

    // === Scan Logic ===
    function setActiveSide(side) {
      sidePills.querySelectorAll('.pill').forEach(p => p.classList.toggle('active', p.dataset.side === side));
    }

    function getActiveSide() {
      return sidePills.querySelector('.pill.active').dataset.side;
    }

    function incLevel(inc) {
      if (inc < 5) return 1;
      if (inc < 10) return 2;
      if (inc < 15) return 3;
      if (inc < 20) return 4;
      return 5;
    }

    function passLTPFilter(h) {
      if (!optLTPFilter.checked) return true;
      const min = ltpMin.value === '' ? -Infinity : Number(ltpMin.value);
      const max = ltpMax.value === '' ? Infinity : Number(ltpMax.value);
      return h.ltp >= min && h.ltp <= max;
    }

    function hitBadge(h, best) {
      const span = document.createElement('span');
      span.className = `hit${best ? ' best' : ''}${optHeatmap.checked ? ' lvl-' + incLevel(h.inc) : ''}`;
      const parts = [];
      if (optLTP.checked && h.ltp != null) parts.push(`LTP ${Number(h.ltp).toFixed(2)}`);
      parts.push(`IV ${Number(h.iv).toFixed(2)}`);
      parts.push(`+${Number(h.inc).toFixed(2)}%`);
      parts.push(`${Number(h.dist_pct).toFixed(2)}%`);
      span.textContent = `${h.strike} (${parts.join(' • ')})`;
      return span;
    }

    function renderHitsCell(hits, bestObj) {
      const td = document.createElement('td');
      td.className = 'hits';
      const shown = [], filtered = [];
      (optBest.checked ? (hits[0] ? [hits[0]] : []) : hits).forEach(h => (passLTPFilter(h) ? shown : filtered).push(h));
      shown.forEach(h => td.appendChild(hitBadge(h, false)));
      if (!shown.length) td.textContent = '-';
      if (filtered.length) {
        const btn = document.createElement('button');
        btn.textContent = `+${filtered.length} filtered`;
        btn.className = 'badge';
        btn.onclick = () => { btn.remove(); filtered.forEach(h => td.appendChild(hitBadge(h, false))); };
        td.appendChild(btn);
      }
      return td;
    }

    function renderRow(b) {
      if (viewMode.value === 'single' && state.focus && b.symbol !== state.focus) return;
      const tr = document.createElement('tr');
      
      // SAFE: Get best hits with fallback
      const ceBest = b.best?.CE?.MaxJump || (Array.isArray(b.ce_hits) && b.ce_hits[0]) || {};
      const peBest = b.best?.PE?.MaxJump || (Array.isArray(b.pe_hits) && b.pe_hits[0]) || {};
      
      // SAFE: Calculate straddle only if both LTP exist
      let straddlePrice = '-';
        if (b.atm_ce_ltp != null && b.atm_pe_ltp != null) {
        const total = Number(b.atm_ce_ltp) + Number(b.atm_pe_ltp);
        straddlePrice = `<span class="straddle-price">₹${total.toFixed(2)}</span>`;
      }

      tr.innerHTML = `
        <td>${b.symbol}</td>
        <td>${b.expiry_used || '-'}</td>
        <td>${Number(b.underlying || 0).toFixed(2)}</td>
        <td>${b.atm_ce_iv != null ? Number(b.atm_ce_iv).toFixed(2) : '-'}</td>
        <td>${b.atm_pe_iv != null ? Number(b.atm_pe_iv).toFixed(2) : '-'}</td>
        <td><span class="straddle-price">${straddlePrice}</span></td>
      `;
      
      tbody.appendChild(tr);
      tr.appendChild(renderHitsCell(b.ce_hits || [], b.best?.CE));
      tr.appendChild(renderHitsCell(b.pe_hits || [], b.best?.PE));
    }

    async function scan() {
      const body = {
        symbols: state.selected.slice(0, 210),
        threshold: Number(thr.value || 5),
        side: getActiveSide(),
        expiry_overrides: state.override
      };
      
      try {
        const res = await fetch('/api/breakout_scan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const err = await res.text();
          throw new Error(`HTTP ${res.status}: ${err}`);
        }

        const text = await res.text();
        let js;
        try {
          js = JSON.parse(text);
        } catch (e) {
          console.error("Invalid JSON:", text);
          throw new Error("Server returned invalid JSON");
        }

        tbody.innerHTML = '';
        (js.data || []).forEach(renderRow);

      } catch (e) {
        console.error("Scan failed:", e);
        tbody.innerHTML = '<tr><td colspan="8" style="color:#ef4444;">Scan failed - check console</td></tr>';
      }
      
      savePrefs();
    }

    // === Strategy Scan ===
    async function runStrategyScan() {
      const buyLots = Number(document.getElementById('buyLots').value || 1);
      const sellLots = Number(document.getElementById('sellLots').value || 3);
      const targetMin = Number(document.getElementById('targetMin').value || 2);
      const targetMax = Number(document.getElementById('targetMax').value || 20);
      const side = document.getElementById('optSide').value || 'ALL';
      const atmFromPct = Number(document.getElementById('atmFromPct').value || 0);
      const atmToPct = Number(document.getElementById('atmToPct').value || 5);
      const minStrikeDiff = Number(document.getElementById('minStrikeDiff').value || 1);
      const maxStrikeDiff = Number(document.getElementById('maxStrikeDiff').value || 10);

      strategyTbody.innerHTML = '<tr><td colspan="9">Scanning... please wait</td></tr>';

      const body = {
        symbols: state.selected.slice(0, 210),
        buy_lots: buyLots,
        sell_lots: sellLots,
        target_diff: (targetMin + targetMax) / 2,
        tolerance: (targetMax - targetMin) / 2,
        side: side,
        atm_from_pct: atmFromPct,
        atm_to_pct: atmToPct,
        min_strike_diff: minStrikeDiff,
        max_strike_diff: maxStrikeDiff,
        expiry_overrides: state.override || {}
      };

      try {
        const res = await fetch('/api/strategy_ltp_scan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const js = await res.json();
        const data = js.data || [];
        strategyTbody.innerHTML = data.length ? '' : '<tr><td colspan="9">No matches found</td></tr>';
        data.forEach(s => {
          s.matches.forEach(m => {
            const tr = document.createElement('tr');
            // Step 1: Debit ya Credit decide karo
const isCredit = m.net_per_lot < 0;  // Agar net negative → credit
const absNet = Math.abs(m.net_per_lot);
const netLabel = isCredit ? 'Credit' : 'Debit';
const netColor = isCredit ? '#10b981' : '#ef4444';
const netSign = isCredit ? '' : '+';

// Step 2: Total P&L color
const totalColor = m.total_pnl >= 0 ? '#ef4444' : '#10b981';

// Step 3: Expiry
const expiry = m.expiry || s.expiry_used || '-';

// Step 4: Puri row banaye
tr.innerHTML = `
  <td>${s.symbol}</td>
  <td>₹${Number(s.underlying||0).toFixed(2)}</td>
  <td>${m.buy_strike} <b style="color:#10b981">${m.buy_side}</b></td>
  <td>${m.sell_strike} <b style="color:#ef4444">${m.sell_side}</b></td>
  <td>${Number(m.buy_ltp).toFixed(2)}</td>
  <td>${Number(m.sell_ltp).toFixed(2)}</td>
  <td style="background:${isCredit?'rgba(34,197,94,0.15)':'rgba(239,68,68,0.15)'}; color:${netColor}; font-weight:600;">
    ${netLabel} ${netSign}${absNet.toFixed(2)}
  </td>
  <td style="color:${totalColor}; font-weight:600;">
    ₹${m.total_pnl >= 0 ? '+' : ''}${Math.abs(m.total_pnl)}
  </td>
  <td>${expiry}</td>
`;
            strategyTbody.appendChild(tr);
          });
        });
      } catch (e) {
        console.error(e);
        strategyTbody.innerHTML = '<tr><td colspan="9">Scan failed (see console)</td></tr>';
      }
    }

    // === Auto Refresh ===
    const AUTO_REFRESH_INTERVAL = 30000;
    let lastDataMap = {};
    function snapshotForCompare(b){
      return JSON.stringify({
        expiry: b.expiry_used,
        underlying: b.underlying,
        atm_ce_iv: b.atm_ce_iv,
        atm_pe_iv: b.atm_pe_iv,
        atm_ce_ltp: b.atm_ce_ltp,
        atm_pe_ltp: b.atm_pe_ltp,
        straddle_atm: b.straddle_atm,
        ce_hit_count: b.ce_hit_count || 0,
pe_hit_count: b.pe_hit_count || 0,
ce_max_inc: b.ce_max_inc || 0,
pe_max_inc: b.pe_max_inc || 0,
bias: b.strategy?.bias || "Neutral"
      });
    }
    function findRowBySymbol(symbol){
      const rows = tbody.querySelectorAll('tr');
      for(const r of rows){
        const td = r.querySelector('td');
        if(td && td.textContent.trim()===symbol) return r;
      }
      return null;
    }
    function updateOrInsertRow(b) {
    const sym = b.symbol;
    const newSnap = snapshotForCompare(b);
    const oldSnap = lastDataMap[sym] ? JSON.parse(lastDataMap[sym]) : null;
    lastDataMap[sym] = newSnap;

    const tr = document.createElement('tr');
    
    // Calculate straddle
    let straddlePrice = '-';
    if (b.atm_ce_ltp != null && b.atm_pe_ltp != null) {
        const total = Number(b.atm_ce_ltp) + Number(b.atm_pe_ltp);
        straddlePrice = `<span class="straddle-price">₹${total.toFixed(2)}</span>`;
    }

    tr.innerHTML = `
        <td>${b.symbol}</td>
        <td>${b.expiry_used || '-'}</td>
        <td>${Number(b.underlying || 0).toFixed(2)}</td>
        <td>${b.atm_ce_iv != null ? Number(b.atm_ce_iv).toFixed(2) : '-'}</td>
        <td>${b.atm_pe_iv != null ? Number(b.atm_pe_iv).toFixed(2) : '-'}</td>
        <td>${straddlePrice}</td>
    `;
    tr.appendChild(renderHitsCell(b.ce_hits || [], b.best?.CE));
    tr.appendChild(renderHitsCell(b.pe_hits || [], b.best?.PE));

    const existing = findRowBySymbol(sym);
    
    // Smart Glow Logic
    let shouldGlow = false;
    let glowType = 'row-glow';

    if (!oldSnap) {
        // First time
        if (b.ce_hit_count > 0 || b.pe_hit_count > 0) {
            shouldGlow = true;
            glowType = b.ce_hit_count > b.pe_hit_count ? 'row-glow-ce' : 'row-glow-pe';
        }
    } else {
        // Compare
        const oldCE = oldSnap.ce_hit_count || 0;
        const oldPE = oldSnap.pe_hit_count || 0;
        const oldMaxCE = oldSnap.ce_max_inc || 0;
        const oldMaxPE = oldSnap.pe_max_inc || 0;
        const oldBias = oldSnap.bias;

        const newCE = b.ce_hit_count || 0;
        const newPE = b.pe_hit_count || 0;
        const newMaxCE = b.ce_max_inc || 0;
        const newMaxPE = b.pe_max_inc || 0;
        const newBias = b.strategy?.bias || "Neutral";

        // 1. Naya hit aaya?
        if (newCE > oldCE || newPE > oldPE) {
            shouldGlow = true;
            glowType = newCE > newPE ? 'row-glow-ce' : 'row-glow-pe';
        }
        // 2. Max IV jump badha?
        else if (newMaxCE > oldMaxCE + 0.5 || newMaxPE > oldMaxPE + 0.5) {
            shouldGlow = true;
            glowType = newMaxCE > newMaxPE ? 'row-glow-ce' : 'row-glow-pe';
        }
        // 3. Bias change?
        else if (oldBias !== "Vol Expansion" && newBias === "Vol Expansion") {
            shouldGlow = true;
            glowType = 'row-glow';
        }
    }

    if (existing) {
        existing.replaceWith(tr);
    } else {
        tbody.appendChild(tr);
    }

    if (shouldGlow) {
        
        setTimeout(() => tr.classList.remove('row-glow', 'row-glow-ce', 'row-glow-pe'), 2200);
    }

    }
    function removeMissingRows(newDataList){
      const present = new Set((newDataList || []).map(x => x.symbol));
      const rows = Array.from(tbody.querySelectorAll('tr'));
      for(const r of rows){
        const td = r.querySelector('td');
        if(!td) continue;
        const sym = td.textContent.trim();
        if(!present.has(sym)){
          r.remove();
          delete lastDataMap[sym];
        }
      }
    }
    // ====== NEW: Fetch Straddle Data from /api/breakout_scan ======
async function fetchStraddleData() {
  try {
    const body = {
      symbols: state.selected.slice(0, 210),
      threshold: 0,  // No IV spike needed
      distance_pct: 0,
      side: "ALL",
      expiry_overrides: state.override
    };

    const res = await fetch('/api/breakout_scan', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    const { data } = await res.json();
    return data || [];
  } catch (e) {
    console.error("Straddle fetch failed:", e);
    return [];
  }
}
    async function backgroundFetchOnce(){
  try{
    const body = {
      symbols: state.selected.slice(0,210),
      threshold: Number(thr.value || 5),
      distance_pct: Number(distInput.value || 0),
      side: getActiveSide(),
      expiry_overrides: state.override
    };
    const res = await fetch('/api/breakout_scan', { 
      method:'POST', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify(body)
    });
    const js = await res.json();
    const list = js.data || [];
    for(const b of list) updateOrInsertRow(b);
    removeMissingRows(list);
    
    // Real-time clock
    const now = new Date();
    const last = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
    const el = document.getElementById('lastUpdated');
    if(el) el.textContent = `Last updated: ${last}`;

    // Keep sort after update
    if (breakoutSort.key) renderSortedBreakout();

  }catch(e){
    console.error('Background fetch failed', e);
  }
}
    let bgInterval = null;
    function startBackgroundUpdater(){
  lastDataMap = {};
  setTimeout(backgroundFetchOnce, 800);
  if(bgInterval) clearInterval(bgInterval);
  bgInterval = setInterval(backgroundFetchOnce, 15000); // 15 sec
}

    // === Event Listeners ===
    sidePills.querySelectorAll('.pill').forEach(p => p.onclick = () => { setActiveSide(p.dataset.side); scan(); });
    addSym.onclick = async () => {
      const v = symInput.value.trim().toUpperCase();
      if (v && !state.selected.includes(v)) {
        state.selected.unshift(v);
        symInput.value = '';
        await ensureExpiries();
        scan();
      }
    };
    loadSuggested.onclick = loadSuggestedSymbols;
    scanBtn.onclick = scan;
    timerSel.onchange = () => { timerSel.value > 0 ? startTimer() : stopTimer(); };
    viewMode.onchange = scan;
    [optStrategy, optHeatmap, optBest, optLTP, optCompact, optLight, optLTPFilter, thr, ltpMin, ltpMax].forEach(el => el.onchange = () => { applyTheme(); applyCompact(); scan(); savePrefs(); });
    document.querySelectorAll('.preset').forEach(p => p.onclick = () => { presets[p.dataset.preset](); savePrefs(); });
    document.getElementById('strategyScanBtn').onclick = runStrategyScan;

    const presets = {
      scalp: () => { thr.value = 3; setActiveSide('ALL'); optLTPFilter.checked = true; ltpMin.value = 1; ltpMax.value = 20; optCompact.checked = true; scan(); },
      swing: () => { thr.value = 6; optLTPFilter.checked = true; ltpMin.value = 20; ltpMax.value = 100; optBest.checked = true; scan(); },
      highiv: () => { thr.value = 10; optLTPFilter.checked = false; scan(); },
      lowiv: () => { thr.value = 2.5; optHeatmap.checked = false; scan(); },
      reset: () => { localStorage.clear(); location.reload(); }
    };

    function startTimer() {
      stopTimer();
      const secs = Number(timerSel.value);
      if (!secs) return;
      state.left = secs;
      countEl.textContent = state.left + 's';
      state.intervalId = setInterval(scan, secs * 1000);
      state.countdownId = setInterval(() => {
        state.left = state.left <= 1 ? secs : state.left - 1;
        countEl.textContent = state.left + 's';
      }, 1000);
    }

    function stopTimer() {
      clearInterval(state.intervalId);
      clearInterval(state.countdownId);
      state.intervalId = state.countdownId = null;
      countEl.textContent = '-';
    }

    // === Init ===
    (async () => {
      loadPrefs();
      if (!state.selected.length) await loadSuggestedSymbols();
      else { await ensureExpiries(); await scan(); }
      if (timerSel.value > 0) startTimer();
      startBackgroundUpdater();
    })();
    // Live clock every second
setInterval(() => {
  const now = new Date();
  const time = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
  const el = document.getElementById('lastUpdated');
  if (el && !el.textContent.includes('Scanning')) {
    el.textContent = `Last updated: ${time}`;
  }
}, 1000);
  </script>
<script>
  // ===== Premium Surge (OTM Bomb) with Notifications =====
  const PREV_SURGE_CACHE = {};
  const surgeTbody = document.getElementById('surgeTbody');
  const surgeMinPct = document.getElementById('surgeMinPct');
  const surgeMinLots = document.getElementById('surgeMinLots');
  const surgeSymbol = document.getElementById('surgeSymbol');
  const surgeScanBtn = document.getElementById('surgeScanBtn');
  const surgeSound = document.getElementById('surgeSound');
  const surgeNotify = document.getElementById('surgeNotify');

  let premiumBgInterval = null;
  let notificationPermission = false;

  // Request Notification Permission
  async function requestNotificationPermission() {
    if (!("Notification" in window)) return;
    if (Notification.permission === "granted") {
      notificationPermission = true;
    } else if (Notification.permission !== "denied") {
      const permission = await Notification.requestPermission();
      notificationPermission = permission === "granted";
    }
  }

  // Play Sound + Show Notification
  function triggerAlert(item) {
    // Sound
    if (surgeSound.checked) {
      try {
        const audio = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
        audio.play().catch(() => {});
      } catch (e) {}
    }

    // Browser Notification
    if (surgeNotify.checked && notificationPermission && document.hidden) {
      const title = `${item.pct.toFixed(0)}% Premium Surge!`;
      const body = `${item.symbol} ${item.strike}${item.side} → ₹${item.curr?.toFixed(2)} (${item.lots.toFixed(1)} lots)`;
      const notif = new Notification(title, {
        body,
        icon: 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡</text></svg>',
        tag: 'surge-' + item.symbol + item.strike + item.side,
        renotify: true
      });
      notif.onclick = () => window.focus();
    }
  }

  function renderSurgeTable(list) {
    surgeTbody.innerHTML = '';
    if (!list || !list.length) {
      surgeTbody.innerHTML = '<tr><td colspan="9" style="color:var(--text-muted);">No surge detected</td></tr>';
      return;
    }

    list.forEach(item => {
      const tr = document.createElement('tr');
      const pctColor = item.pct >= 1000 ? '#ef4444' : 
                       item.pct >= 500 ? '#f59e0b' : 
                       item.pct >= 300 ? '#facc15' : '#10b981';

      const glowClass = item.pct >= 500 ? 'row-glow' : 
                        item.pct >= 300 ? 'row-glow-ce' : '';

      tr.className = glowClass;
     const strengthColor = item.strength === 'NUCLEAR' ? '#ff0033' :
                      item.strength === 'EXTREME' ? '#ff4400' :
                      item.strength === 'STRONG' ? '#ff8800' : '#00ff00';

const typeColor = item.type?.includes('INSTITUTIONAL') ? '#ff00ff' : '#ffff00';

tr.innerHTML = `
  <td><strong>${item.symbol}</strong></td>
  <td>${item.strike}</td>
  <td><span style="color:${item.side==='CE'?'#10b981':'#ef4444'};font-weight:700;">${item.side}</span></td>
  <td>${item.prev != null ? item.prev.toFixed(2) : '-'}</td>
  <td style="font-weight:600; color:#10b981;">${item.curr != null ? item.curr.toFixed(2) : '-'}</td>
  <td style="font-weight:700; color:${pctColor};">${Number(item.pct).toFixed(1)}%</td>
  <td><span style="padding:4px 10px; border-radius:6px; font-weight:800; color:white; background:${strengthColor}; box-shadow:0 0 10px ${strengthColor}66;">${item.strength || '-'}</span></td>
  <td style="color:${typeColor}; font-weight:700;">${item.type || '-'}</td>
  <td style="color:#fbbf24; font-weight:600;">${item.speed ? item.speed + '%' : '-'}</td>
  <td style="font-size:0.85em; color:#cbd5e1;">${item.timestamp || ''}</td>
  <td>${item.volume || 0}</td>
  <td>${(item.lots || 0).toFixed(2)}</td>
  <td style="font-size:0.8rem; color:var(--text-muted);">${item.expiry || '-'}</td>
`;

      // Trigger alert on big jump
      if (item.pct >= 300) {
        triggerAlert(item);
      }

      surgeTbody.appendChild(tr);

      // Auto-remove glow after animation
      if (glowClass) {
        setTimeout(() => tr.classList.remove('row-glow', 'row-glow-ce'), 2000);
      }
    });
  }

  async function fetchPremiumSurge() {
    try {
      const body = {
        symbols: surgeSymbol.value.trim() ? [surgeSymbol.value.trim().toUpperCase()] : state.selected.slice(0,210),
        min_pct: Number(surgeMinPct.value || 200),
        min_lots: Number(surgeMinLots.value || 1),
        expiry_overrides: state.override || {}
      };
      const res = await fetch('/api/premium_surge', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if (!res.ok) return [];
      const js = await res.json();
      return js.data || [];
    } catch (e) {
      console.error('Premium surge error', e);
      return [];
    }
  }

  async function premiumBackgroundOnce(){
    const list = await fetchPremiumSurge();
    renderSurgeTable(list);
  }

  function startPremiumUpdater(){
    requestNotificationPermission();
    if (premiumBgInterval) clearInterval(premiumBgInterval);
    premiumBackgroundOnce();
    premiumBgInterval = setInterval(premiumBackgroundOnce, 15000);
  }

  function stopPremiumUpdater(){
    if (premiumBgInterval) clearInterval(premiumBgInterval);
    premiumBgInterval = null;
  }

  surgeScanBtn.onclick = async () => {
    const isSurgeActive = document.querySelector('#tab-surge').classList.contains('active');
    if (!isSurgeActive) return;
    const list = await fetchPremiumSurge();
    renderSurgeTable(list);
  };

  // Tab Switch Handler
  document.getElementById('mainTabs').addEventListener('click', (e) => {
    const tab = e.target.dataset.tab;
    if (tab === 'surge') {
      startPremiumUpdater();
    } else {
      stopPremiumUpdater();
    }
  });

  // Auto-start on load if tab is active
  const _origStartBackgroundUpdater = startBackgroundUpdater;
  startBackgroundUpdater = function(){
    _origStartBackgroundUpdater();
    const active = document.querySelector('#mainTabs .pill.active')?.dataset?.tab;
    if (active === 'surge') startPremiumUpdater();
  };

  // Auto-request permission on first interaction
  document.addEventListener('click', () => {
    if (!notificationPermission && surgeNotify && surgeNotify.checked) {
      requestNotificationPermission();
    }
  }, { once: true });
</script>

<!-- SOCKET.IO CLIENT & INTEGRATION (ADDED FOR REAL-TIME BREAKOUT UPDATES) -->

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<script>
  // === WebSocket (socket.io) client integration ===
  const socket = io();

  let socketSubscribed = false;
  let socketInterval = 15; // default seconds

  socket.on("connect", () => {
    console.log("Socket connected:", socket.id);
    // start subscription after connect
    startSocketSubscription();
  });

  socket.on("disconnect", (reason) => {
    console.log("Socket disconnected:", reason);
    socketSubscribed = false;
  });

  socket.on("realtime_started", (d) => {
    console.log("Realtime started ack:", d);
  });

  socket.on("realtime_stopped", (d) => {
    console.log("Realtime stopped ack:", d);
  });

  // Receive realtime update -> update table smartly
  socket.on("update_data", (packet) => {
    try {
      const list = packet.data || [];
      // Use existing updateOrInsertRow / removeMissingRows logic if present
      if (typeof updateOrInsertRow === "function" && typeof removeMissingRows === "function") {
        for (const b of list) updateOrInsertRow(b);
        removeMissingRows(list);
      } else if (typeof renderRow === "function") {
        // fallback: full redraw using renderRow
        tbody.innerHTML = '';
        list.forEach(renderRow);
      } else {
        console.log("No render functions found; received data:", list);
      }
      // update timestamp UI
      const now = new Date();
      const el = document.getElementById('lastUpdated');
      if (el) el.textContent = `Last updated: ${now.toLocaleTimeString()}`;
    } catch (e) {
      console.error("Error handling realtime packet:", e);
    }
  });

  // Start / restart subscription using current client state
  async function startSocketSubscription() {
    if (!socket || !socket.connected) return;
    // stop existing first
    stopSocketSubscription();

    const symbols = state.selected.slice(0, 210);
    const payload = {
      symbols: symbols,
      threshold: Number(thr.value || 5),
      side: getActiveSide(),
      interval: Number(timerSel.value) || 15,
      expiry_overrides: state.override || {}
    };
    socketInterval = payload.interval || 15;
    socket.emit("start_realtime", payload);
    socketSubscribed = true;
    console.log("Sent start_realtime:", payload);
  }

  function stopSocketSubscription() {
    if (!socket || !socket.connected || !socketSubscribed) return;
    socket.emit("stop_realtime", {});
    socketSubscribed = false;
    console.log("Sent stop_realtime");
  }

  // Hook into places where watchlist or params change
  const needRestartEls = [thr, timerSel, ltpMin, ltpMax, distInput];
  needRestartEls.forEach(el => {
    if (el) el.addEventListener('change', () => {
      startSocketSubscription();
    });
  });

  // When watchlist changes (add/remove/override), restart subscription
  const originalRenderWatch = renderWatch;
  renderWatch = function() {
    originalRenderWatch();
    setTimeout(() => startSocketSubscription(), 120);
  };

  // Also restart when side pill changes
  if (sidePills) {
    sidePills.querySelectorAll('.pill').forEach(p => {
      p.addEventListener('click', () => {
        setActiveSide(p.dataset.side);
        startSocketSubscription();
        scan();
      });
    });
  }

  // Clean up on page unload
  window.addEventListener("beforeunload", () => {
    try { stopSocketSubscription(); } catch (e) {}
    if (socket) socket.close();
  });

  // If user manually clicks Scan Now, also request a one-off REST scan (keeps behavior)
  if (scanBtn) {
    scanBtn.addEventListener('click', () => {
      scan();
      startSocketSubscription();
    });
  }

  // Start when page ready (if socket already connected)
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      if (socket && socket.connected) startSocketSubscription();
    }, 500);
  });
</script>
<!-- END SOCKET.IO CLIENT -->

</body>
</html>
